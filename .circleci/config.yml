version: 2.1

jobs:
  build:
    docker:
      - image: cimg/python:3.10.16
    steps:
      - checkout
      - run: |
          echo "=== BUILD START ==="
          echo "Running build step..."
          echo "Build completed successfully."
          echo "=== BUILD END ==="

  test:
    docker:
      - image: cimg/python:3.10
        environment:
          EDGE_DELTA_HTTP_URL: https://6ebf4e82-073c-426b-9f56-f9b1915c6ab1-http-us-west2-cf.aws.edgedelta.com

    steps:
      - checkout

      # Install test dependencies (pytest, etc.)
      - run:
          name: Install Test Dependencies
          command: |
            pip install pytest --quiet

      # Run real tests and capture stdout
      - run:
          name: Run Tests and Capture Logs
          command: |
            {
              echo "=== TEST RUN START ==="
              echo "Running pytest..."
              python -m pytest -q || true
              echo "Pytest exited with code $?"
              echo "=== TEST RUN END ==="
            } | tee /tmp/circle_logs.txt

      # Generate additional synthetic logs for volume
      - run:
          name: Generate Realistic CI Logs
          command: |
            for job in test lint build deploy; do
              status_array=("passed" "failed" "errored")
              status=${status_array[$RANDOM % 3]}

              failed_tests=()
              if [ "$status" = "failed" ]; then
                failed_tests=("test_flaky_feature" "test_edge_case_$(($RANDOM % 10))")
              fi

              json=$(jq -n \
                --arg job "$job" \
                --arg repo "$CIRCLE_PROJECT_REPONAME" \
                --arg branch "$CIRCLE_BRANCH" \
                --arg commit "$CIRCLE_SHA1" \
                --arg pr_url "$CIRCLE_PULL_REQUEST" \
                --arg status "$status" \
                --argjson failed_tests "$(printf '%s\n' "${failed_tests[@]}" | jq -R . | jq -s .)" \
                --arg ts "$(date -u +%FT%TZ)" \
                '{job: $job, repo: $repo, branch: $branch, commit: $commit, pr_url: $pr_url, status: $status, failed_tests: $failed_tests, timestamp: $ts}')

              echo "$json" | tee -a /tmp/circle_logs.txt
            done


      # Forward every line to Edge Delta
      - run:
          name: Forward All Logs to Edge Delta
          command: |
            while IFS= read -r line; do
            curl -s -X POST -H "Content-Type: application/json" --data-binary "$line" "$EDGE_DELTA_HTTP_URL"
            done < /tmp/circle_logs.txt
      - run:
          name: Emit CI build metadata to Edge Delta
          when: always
          command: |
            # Determine job status
            if [ "$CIRCLE_JOB_STATUS" = "success" ]; then
              STATUS="passed"
            else
              STATUS="failed"
            fi

            # Create structured CI payload
            cat > build.json \<< 'EOF'
            {
              "job": "__JOB__",
              "repo": "edge-delta-circle-ci-demo",
              "branch": "__BRANCH__",
              "commit": "__COMMIT__",
              "pr_url": "__PR__",
              "status": "__STATUS__",
              "failed_tests": ["test_intentional_ci_failure"],
              "timestamp": "__TS__"
            }
            EOF

            sed -i \
              -e "s|__JOB__|$CIRCLE_JOB|g" \
              -e "s|__BRANCH__|$CIRCLE_BRANCH|g" \
              -e "s|__COMMIT__|$CIRCLE_SHA1|g" \
              -e "s|__PR__|$CIRCLE_PULL_REQUEST|g" \
              -e "s|__STATUS__|$STATUS|g" \
              -e "s|__TS__|$(date -u +"%Y-%m-%dT%H:%M:%SZ")|g" \
              build.json

            # Send to Edge Delta
            curl -s -X POST "$EDGE_DELTA_HTTP_URL" \
              -H "Content-Type: application/json" \
              -d @build.json



workflows:
  build_and_test:
    jobs:
      - build
      - test
