version: 2.1

jobs:
  test-and-report:
    docker:
      - image: cimg/python:3.10

    environment:
      EDGE_DELTA_HTTP_URL: "http://caaecd16-2026-460e-8501-9e6563a1b2cf-http-us-west2-cf.aws.edgedelta.com"

    steps:
      - checkout

      - run:
          name: Install dependencies
          command: |
            python -m pip install --upgrade pip
            pip install pytest pytest-json-report

      - run:
          name: Run tests and generate JSON report
          command: |
            mkdir -p test_results
            pytest --json-report --json-report-file=test_results/report.json || true

      - run:
          name: Build payload for Edge Delta
          command: |
            python << 'PY'
import json, os
from datetime import datetime

report_file = "test_results/report.json"

if not os.path.exists(report_file):
    print("No pytest report â€” skipping.")
    exit(0)

with open(report_file) as f:
    report = json.load(f)

failed_tests = [
    t["nodeid"]
    for t in report.get("tests", [])
    if t["outcome"] == "failed"
]

status = "passed" if len(failed_tests) == 0 else "failed"

payload = {
    "circle_job": os.getenv("CIRCLE_JOB"),
    "repo": os.getenv("CIRCLE_PROJECT_REPONAME"),
    "branch": os.getenv("CIRCLE_BRANCH"),
    "commit": os.getenv("CIRCLE_SHA1"),
    "workflow_id": os.getenv("CIRCLE_WORKFLOW_ID"),
    "status": status,
    "failed_tests": failed_tests,
    "total_tests": len(report.get("tests", [])),
    "timestamp": datetime.utcnow().isoformat() + "Z",
}

with open("build_payload.json", "w") as f:
    f.write(json.dumps(payload, indent=2))

print("Payload created:")
print(json.dumps(payload, indent=2))
PY

      - run:
          name: Send payload to Edge Delta
          command: |
            if [ -f build_payload.json ]; then
              curl -sS -X POST "$EDGE_DELTA_HTTP_URL" \
                -H "Content-Type: application/json" \
                --data-binary @build_payload.json || true
            fi

workflows:
  version: 2
  ci-tests:
    jobs:
      - test-and-report
