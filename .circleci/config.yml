version: 2.1

jobs:
  build:
    docker:
      - image: cimg/python:3.10.16
    steps:
      - checkout
      - run: |
          echo "=== BUILD START ==="
          echo "Running build step..."
          echo "Build completed successfully."
          echo "=== BUILD END ==="
  canary_deploy:
    docker:
      - image: cimg/python:3.10
    environment:
      PYTHONPATH: /home/circleci/project
    steps:
      - checkout

      - run:
          name: Install dependencies
          command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt

      - run:
          name: Send Canary Metrics to Edge Delta
          command: python app/canary_metrics.py
  canary_probe:
    docker:
      - image: cimg/python:3.10.16
    environment:
      EDGE_DELTA_HTTP_URL: https://6ebf4e82-073c-426b-9f56-f9b1915c6ab1-http-us-west2-cf.aws.edgedelta.com
      DEPLOYMENT_VARIANT: "canary"
    resource_class: small
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-venv-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - v1-venv-

      - run:
          name: Set up Python and install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi
      - run:
          name: Emit canary deployment event
          command: |
            curl -s -X POST "$EDGE_DELTA_HTTP_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "event_type": "deployment",
                "repo": "edge-delta-circle-ci-demo",
                "branch": "'"$CIRCLE_BRANCH"'",
                "deployment.variant": "canary",
                "deployment.strategy": "canary",
                "source": "circleci",
                "timestamp": "'"$(date -u +%FT%TZ)"'"
              }'
      
      - save_cache:
          key: v1-venv-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
          paths:
            - venv


      - run:
          name: Run canary probe
          environment:
            ED_CANARY_URL: "${ED_CANARY_URL}"
            ED_CANARY_METHOD: "${ED_CANARY_METHOD}"
            ED_CANARY_EXPECTED_STATUS: "${ED_CANARY_EXPECTED_STATUS}"
            ED_CANARY_SEARCH_TEXT: "${ED_CANARY_SEARCH_TEXT}"
            ED_CANARY_TIMEOUT: "${ED_CANARY_TIMEOUT}"
            ED_CANARY_RETRIES: "${ED_CANARY_RETRIES}"
            ED_CANARY_RETRY_BACKOFF: "${ED_CANARY_RETRY_BACKOFF}"
            ED_CANARY_HEADERS: "${ED_CANARY_HEADERS}"
            ED_CANARY_BODY: "${ED_CANARY_BODY}"
            ED_CANARY_JSON: "${ED_CANARY_JSON}"
          command: |
            . venv/bin/activate
            python scripts/canary_probe.py

  test:
    docker:
      - image: cimg/python:3.10
        environment:
          EDGE_DELTA_HTTP_URL: https://6ebf4e82-073c-426b-9f56-f9b1915c6ab1-http-us-west2-cf.aws.edgedelta.com
          PYTHONPATH: /home/circleci/project

    steps:
      - checkout
      - run:
          name: Install project package
          command: pip install -e .

      - run:
          name: Install Test Dependencies
          command: |
            python -m pip install --upgrade pip
            pip install pytest --quiet

      - run:
          name: Create test results directory
          command: mkdir -p test-results/pytest

      - run:
          name: Run pytest with JUnit XML
          command: |
            set -euo pipefail
            pytest -q --maxfail=1 --durations=25 --junitxml=test-results/pytest/pytest.xml

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: test-results
          destination: test-results

          
      - run:
          name: Run flaky test (intentional)
          command: |
            echo "=== FLAKY TEST START ==="
            python app/flaky-test.py || echo "Flaky test failed (expected intermittently)"
            echo "=== FLAKY TEST END ==="
      - run:
          name: Emit flaky test failure event to Edge Delta
          when: always
          command: |
            echo '{
              "repo": "edge-delta-circle-ci-demo",
              "test_name": "test_payment_timeout",
              "status": "failed",
              "job": "test",
              "timestamp": "'$(date -u +%FT%TZ)'"
            }' | curl -s -X POST "$EDGE_DELTA_HTTP_URL" \
                -H "Content-Type: application/json" \
                -d @-


      - run:
          name: Generate Demo Logs for AI Teammates
          command: |
            status_array=("passed" "failed" "error")
            for i in {1..20}; do
              job="synthetic-run-tests"
              status=${status_array[$RANDOM % ${#status_array[@]}]}
              failed_tests=()
              if [ "$status" = "failed" ] || [ "$status" = "error" ]; then
                failed_tests=("test_flaky_feature" "test_edge_case_$((RANDOM % 10))")
              fi
              duration=$((30 + RANDOM % 90))
              ts=$(date -u +%FT%TZ)
              branch="demo/ai-ci-triage"
              commit=$(git rev-parse HEAD || echo "abcdef123456")
              pr_url="https://github.com/nthomson0317/edge-delta-circle-ci-demo/pull/$((RANDOM % 100))"

              json=$(jq -n \
                --arg job "$job" \
                --arg repo "edge-delta-circle-ci-demo" \
                --arg branch "$branch" \
                --arg commit "$commit" \
                --arg pr_url "$pr_url" \
                --arg status "$status" \
                --argjson failed_tests "$(printf '%s\n' "${failed_tests[@]}" | jq -R . | jq -s .)" \
                --arg duration "$duration" \
                --arg ts "$ts" \
                '{job: $job, repo: $repo, branch: $branch, commit: $commit, pr_url: $pr_url, status: $status, failed_tests: $failed_tests, duration: ($duration|tonumber), timestamp: $ts, pipeline:"nicholas_demo"}')

              echo "$json" | curl -s -X POST -H "Content-Type: application/json" --data-binary @- "$EDGE_DELTA_HTTP_URL"
            done
            echo "Synthetic demo logs sent."

      # Generate additional synthetic logs for volume
      - run:
          name: Generate Realistic CI Logs
          command: |
            for job in test lint build deploy; do
              status_array=("passed" "failed" "errored")
              status=${status_array[$RANDOM % 3]}

              failed_tests=()
              if [ "$status" = "failed" ]; then
                failed_tests=("test_flaky_feature" "test_edge_case_$(($RANDOM % 10))")
              fi

              json=$(jq -n \
                --arg job "$job" \
                --arg repo "$CIRCLE_PROJECT_REPONAME" \
                --arg branch "$CIRCLE_BRANCH" \
                --arg commit "$CIRCLE_SHA1" \
                --arg pr_url "$CIRCLE_PULL_REQUEST" \
                --arg status "$status" \
                --argjson failed_tests "$(printf '%s\n' "${failed_tests[@]}" | jq -R . | jq -s .)" \
                --arg ts "$(date -u +%FT%TZ)" \
                '{job: $job, repo: $repo, branch: $branch, commit: $commit, pr_url: $pr_url, status: $status, failed_tests: $failed_tests, timestamp: $ts}')

              echo "$json" | tee -a /tmp/circle_logs.txt
              echo "npm ERR! code ETIMEDOUT"
              echo "npm ERR! network request to https://registry.npmjs.org failed, reason: connect ETIMEDOUT"
              echo '{"source":"network","service":"npm-registry","error":"connection timeout","region":"us-west","severity":"warning"}'
              echo "Outbound HTTP requests to registry.npmjs.org exceeding p95 latency"



            done
      - run:
          name: Simulate npm timeout failure
          command: |
            echo "npm ERR! code ETIMEDOUT"
            echo "npm ERR! network request to https://registry.npmjs.org failed, reason: connect ETIMEDOUT"
            exit 1
        

            # Forward every line to Edge Delta
      - run:
          name: Forward All Logs to Edge Delta
          command: |
              while IFS= read -r line; do
              curl -s -X POST -H "Content-Type: application/json" --data-binary "$line" "$EDGE_DELTA_HTTP_URL"
              done < /tmp/circle_logs.txt

      - run:
          name: Emit CI build metadata to Edge Delta
          when: always
          command: |
            # Determine job status
            if [ "$CIRCLE_JOB_STATUS" = "success" ]; then
              STATUS="passed"
            else
              STATUS="failed"
            fi

            # Create structured CI payload
            cat > build.json \<< 'EOF'
            {
              "job": "__JOB__",
              "repo": "edge-delta-circle-ci-demo",
              "branch": "__BRANCH__",
              "commit": "__COMMIT__",
              "pr_url": "__PR__",
              "status": "__STATUS__",
              "failed_tests": ["test_intentional_ci_failure"],
              "timestamp": "__TS__"
            }
            EOF

            sed -i \
              -e "s|__JOB__|$CIRCLE_JOB|g" \
              -e "s|__BRANCH__|$CIRCLE_BRANCH|g" \
              -e "s|__COMMIT__|$CIRCLE_SHA1|g" \
              -e "s|__PR__|$CIRCLE_PULL_REQUEST|g" \
              -e "s|__STATUS__|$STATUS|g" \
              -e "s|__TS__|$(date -u +"%Y-%m-%dT%H:%M:%SZ")|g" \
              build.json

            # Send to Edge Delta
            curl -s -X POST "$EDGE_DELTA_HTTP_URL" \
              -H "Content-Type: application/json" \
              -d @build.json
      - run:
          name: Emit structured build metadata (npm timeout example)
          when: always
          command: |
            cat \<< 'EOF' > build_stage_event.json
            {
              "job": "build",
              "repo": "edge-delta-circle-ci-demo",
              "stage": "install",
              "tool": "npm",
              "error_type": "timeout",
              "error_code": "ETIMEDOUT",
              "ci_url": "${CIRCLE_BUILD_URL}",
              "timestamp": "$(date -u +%FT%TZ)"
            }
            EOF

            curl -s -X POST "$EDGE_DELTA_HTTP_URL" \
              -H "Content-Type: application/json" \
              -d @build_stage_event.json




workflows:
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
      - canary_deploy:
          requires:
            - build
            - canary_probe
      - canary_probe:
          filters:
            branches:
              only:
                - main
                - demo/canary
                - feat/ed-canary-probe


