version: 2.1

jobs:
  run-tests:
    docker:
      - image: cimg/python:3.10
    environment:
      EDGE_DELTA_HTTP_URL: "http://caaecd16-2026-460e-8501-9e6563a1b2cf-http-us-west2-cf.aws.edgedelta.com"
    steps:
      - checkout

      - run:
          name: Install dependencies
          command: |
            python -m pip install --upgrade pip
            pip install pytest

      - run:
          name: Run tests (tests_flaky.py) and generate build.json
          command: |
            # run the test suite once
            pytest tests_flaky.py -q
            exit_code=$?

            # parse failures from pytest output
            python - <<'PY'
import json, os, subprocess, re
from datetime import datetime

# Run tests with captured output
proc = subprocess.run(
    ["pytest", "tests_flaky.py", "-q"],
    capture_output=True, text=True
)

status = "passed" if proc.returncode == 0 else "failed"

# Extract failed test names
failed_tests = []
if status == "failed":
    for line in proc.stdout.splitlines():
        match = re.match(r"FAILED\s+(\S+)", line)
        if match:
            failed_tests.append(match.group(1))

payload = {
    "job": os.getenv("CIRCLE_JOB"),
    "workflow": os.getenv("CIRCLE_WORKFLOW_ID"),
    "repo": os.getenv("CIRCLE_PROJECT_REPONAME"),
    "branch": os.getenv("CIRCLE_BRANCH"),
    "commit": os.getenv("CIRCLE_SHA1"),
    "status": status,
    "failed_tests": failed_tests,
    "timestamp": datetime.utcnow().isoformat() + "Z"
}

with open("build.json", "w") as f:
    json.dump(payload, f)

print("Generated build.json:")
print(json.dumps(payload, indent=2))
PY

            # exit CI based on original test status
            if [ $exit_code -ne 0 ]; then
              echo "Tests failed"
            fi

      - run:
          name: Send build status to Edge Delta
          command: |
            if [ -f build.json ]; then
              echo "Sending build.json to Edge Delta..."
              curl -sS -X POST "$EDGE_DELTA_HTTP_URL" \
                -H "Content-Type: application/json" \
                --data-binary @build.json || true
            else
              echo "No build.json found"
            fi

workflows:
  version: 2
  test_and_post:
    jobs:
      - run-tests
