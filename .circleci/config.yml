version: 2.1

jobs:
  build:
    docker:
      - image: cimg/base:2023.03
    steps:
      - checkout
      - run: echo "this is the build job"

  test:
    docker:
      - image: cimg/python:3.10
    environment:
      EDGE_DELTA_HTTP_URL: "http://caaecd16-2026-460e-8501-9e6563a1b2cf-http-us-west2-cf.aws.edgedelta.com"
    steps:
      - checkout

      - run:
          name: Run a simple test
          command: |
            echo "running example test"
            # simulate a pass/fail toggle
            TEST_STATUS="passed"
            echo $TEST_STATUS > test_status.txt

      - run:
          name: Build JSON payload for Edge Delta
          command: |
            cat > build_payload.py << 'EOF'
import json, os
from datetime import datetime

# read status from file
status = open("test_status.txt").read().strip()

payload = {
    "circle_job": os.getenv("CIRCLE_JOB"),
    "repo": os.getenv("CIRCLE_PROJECT_REPONAME"),
    "branch": os.getenv("CIRCLE_BRANCH"),
    "commit": os.getenv("CIRCLE_SHA1"),
    "workflow_id": os.getenv("CIRCLE_WORKFLOW_ID"),
    "status": status,
    "timestamp": datetime.utcnow().isoformat() + "Z"
}

with open("build_payload.json", "w") as f:
    f.write(json.dumps(payload, indent=2))

print("Payload created:")
print(json.dumps(payload, indent=2))
EOF

            python build_payload.py

      - run:
          name: Send payload to Edge Delta
          command: |
            if [ -f build_payload.json ]; then
              curl -sS -X POST "$EDGE_DELTA_HTTP_URL" \
                -H "Content-Type: application/json" \
                --data-binary @build_payload.json || true
            else
              echo "No build_payload.json found"
            fi

workflows:
  build_and_test:
    jobs:
      - build
      - test
