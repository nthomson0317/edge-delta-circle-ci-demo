version: 2.1

jobs:
  run-tests:
    docker:
      - image: cimg/python:3.10
    environment:
      EDGE_DELTA_HTTP_URL: "http://6ebf4e82-073c-426b-9f56-f9b1915c6ab1-http-us-west2-cf.aws.edgedelta.com"

    steps:
      - checkout

      - run:
          name: Install dependencies
          command: |
            python3 -m pip install --upgrade pip
            pip3 install pytest

      - run:
          name: Run pytest and capture output
          command: |
            # Run tests and capture console output to file for parsing
            pytest -q --disable-warnings --maxfail=1 > pytest_output.txt 2>&1 || true
            echo "Saved pytest output to pytest_output.txt"

      - run:
          name: Build payload
          command: |
            python3 scripts/build_payload.py

      - run:
          name: Post to Edge Delta
          command: |
            if [ -f build.json ]; then
              echo "Posting to $EDGE_DELTA_HTTP_URL"
              curl -v -X POST "$EDGE_DELTA_HTTP_URL" -H "Content-Type: application/json" --data-binary @build.json || true
            else
              echo "No build.json found"
            fi

workflows:
  build_and_test:
    jobs:
      - run-tests
