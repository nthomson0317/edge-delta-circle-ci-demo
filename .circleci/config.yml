version: 2.1

jobs:
  build:
    docker:
      - image: cimg/base:2023.03
    steps:
      - checkout
      - run: |
          echo "=== BUILD START ==="
          echo "Running build step..."
          echo "Build completed successfully."
          echo "=== BUILD END ==="

  test:
    docker:
      - image: cimg/python:3.10
    environment:
      EDGE_DELTA_HTTP_URL: "http://6ebf4e82-073c-426b-9f56-f9b1915c6ab1-http-us-west2-cf.aws.edgedelta.com"
    steps:
      - checkout

      # Install test dependencies (pytest, etc.)
      - run:
          name: Install Test Dependencies
          command: |
            pip install pytest --quiet

      # Run real tests and capture stdout
      - run:
          name: Run Tests and Capture Logs
          command: |
            {
              echo "=== TEST RUN START ==="
              echo "Running pytest..."
              python -m pytest -q || true
              echo "Pytest exited with code $?"
              echo "=== TEST RUN END ==="
            } | tee /tmp/circle_logs.txt

      # Generate additional synthetic logs for volume
      - run:
          name: Generate Additional Pipeline Logs
          command: |
            echo "=== SYNTHETIC LOGS START ===" >> /tmp/circle_logs.txt
            for i in {1..100}; do
              echo "Synthetic CircleCI log line #$i - status=ok job=demo step=step_$((i % 5))"
            done >> /tmp/circle_logs.txt
            echo "=== SYNTHETIC LOGS END ===" >> /tmp/circle_logs.txt

      # Forward every line to Edge Delta
      - run:
          name: Forward All Logs to Edge Delta
          command: |
            while IFS= read -r line; do
              json="{\"message\":\"$line\",\"source\":\"circleci\",\"timestamp\":\"$(date -u +%FT%TZ)\"}"
              echo "$json" | curl -s -X POST \
                -H "Content-Type: application/json" \
                --data-binary @- \
                "$EDGE_DELTA_HTTP_URL/"
            done < /tmp/circle_logs.txt
            echo "Done sending logs."

workflows:
  build_and_test:
    jobs:
      - build
      - test
